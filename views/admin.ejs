<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
  <%- include('partials/nav', { user: user }) %>

  <main class="flex-1 container mx-auto p-6 space-y-6">
    <h2 class="text-2xl font-bold text-blue-400">Admin Panel</h2>

    <!-- CSV Import / Export -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <form action="/upload-csv" method="POST" enctype="multipart/form-data" class="flex items-center gap-2">
        <input type="file" name="csvfile" accept=".csv" required class="bg-gray-700 p-2 rounded">
        <button class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">Upload CSV</button>
      </form>
      <a href="/export-csv" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Export CSV</a>
    </div>

    <!-- Search -->
    <div>
      <input id="search" type="text" placeholder="Search by name, email, mobile..." class="w-full p-2 border rounded text-black">
    </div>

    <% const csvAttendees = attendees.filter(a => a.source === 'csv'); %>
    <% const manualAttendees = attendees.filter(a => a.source !== 'csv'); %>

    <!-- CSV Uploaded Attendees Table -->
    <h3 class="text-xl font-bold text-blue-400 mt-6 mb-2">CSV Uploaded Attendees</h3>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse bg-gray-800 rounded-lg overflow-hidden text-sm md:text-base">
        <thead>
          <tr class="bg-gray-700 text-white">
            <th class="p-2">#</th>
            <th class="p-2">Name</th>
            <th class="p-2">Email</th>
            <th class="p-2">Mobile</th>
            <th class="p-2">Designation</th>
            <th class="p-2">Category</th>
            <th class="p-2">Company</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="csv-attendee-table">
          <% csvAttendees.forEach((att, index) => { %>
            <tr class="border-b border-gray-700 attendee-row"
                data-name="<%= att.name %>"
                data-email="<%= att.email %>"
                data-mobile="<%= att.mobile %>">
              <td class="p-2"><%= index + 1 %></td>
              <td class="p-2"><%= att.name %></td>
              <td class="p-2 break-all"><%= att.email %></td>
              <td class="p-2"><%= att.mobile %></td>
              <td class="p-2"><%= att.designation %></td>
              <td class="p-2"><%= att.category %></td>
              <td class="p-2"><%= att.company %></td>
              <td class="p-2 space-x-1 whitespace-nowrap">
                <button type="button"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded edit-btn"
                        data-id="<%= att.id %>"
                        data-name="<%= att.name %>"
                        data-email="<%= att.email %>"
                        data-mobile="<%= att.mobile %>"
                        data-designation="<%= att.designation %>"
                        data-category="<%= att.category %>"
                        data-company="<%= att.company %>">
                  Edit
                </button>
                <form action="/delete/<%= att.id %>" method="POST" class="inline">
                  <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded"
                          onclick="return confirm('Delete <%= att.name %>?');">
                    Delete
                  </button>
                </form>
                <a href="/badge/<%= att.id %>" target="_blank"
                   class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">
                  Print
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Manually Registered Attendees Table -->
    <h3 class="text-xl font-bold text-green-400 mt-6 mb-2">Manually Registered Attendees</h3>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse bg-gray-800 rounded-lg overflow-hidden text-sm md:text-base">
        <thead>
          <tr class="bg-gray-700 text-white">
            <th class="p-2">#</th>
            <th class="p-2">Name</th>
            <th class="p-2">Email</th>
            <th class="p-2">Mobile</th>
            <th class="p-2">Designation</th>
            <th class="p-2">Category</th>
            <th class="p-2">Company</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="manual-attendee-table">
          <% manualAttendees.forEach((att, index) => { %>
            <tr class="border-b border-gray-700 attendee-row"
                data-name="<%= att.name %>"
                data-email="<%= att.email %>"
                data-mobile="<%= att.mobile %>">
              <td class="p-2"><%= index + 1 %></td>
              <td class="p-2"><%= att.name %></td>
              <td class="p-2 break-all"><%= att.email %></td>
              <td class="p-2"><%= att.mobile %></td>
              <td class="p-2"><%= att.designation %></td>
              <td class="p-2"><%= att.category %></td>
              <td class="p-2"><%= att.company %></td>
              <td class="p-2 space-x-1 whitespace-nowrap">
                <button type="button"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded edit-btn"
                        data-id="<%= att.id %>"
                        data-name="<%= att.name %>"
                        data-email="<%= att.email %>"
                        data-mobile="<%= att.mobile %>"
                        data-designation="<%= att.designation %>"
                        data-category="<%= att.category %>"
                        data-company="<%= att.company %>">
                  Edit
                </button>
                <form action="/delete/<%= att.id %>" method="POST" class="inline">
                  <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded"
                          onclick="return confirm('Delete <%= att.name %>?');">
                    Delete
                  </button>
                </form>
                <a href="/badge/<%= att.id %>" target="_blank"
                   class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">
                  Print
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
      <h3 class="text-xl font-bold mb-4">Edit Attendee</h3>
      <form id="editForm" method="POST">
        <input id="edit-name" name="name" class="w-full p-2 mb-2 border rounded text-black" required>
        <input id="edit-email" name="email" type="email" class="w-full p-2 mb-2 border rounded text-black" required>
        <input id="edit-mobile" name="mobile" class="w-full p-2 mb-2 border rounded text-black" required>
        <input id="edit-designation" name="designation" class="w-full p-2 mb-2 border rounded text-black">
        <input id="edit-company" name="company" class="w-full p-2 mb-2 border rounded text-black">
        <select id="edit-category" name="category" class="w-full p-2 mb-2 border rounded text-black" required>
          <option value="Delegate">Delegate</option>
          <option value="Faculty">Faculty</option>
          <option value="Organizer">Organizer</option>
        </select>
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" id="editCancel" class="px-4 py-2 bg-gray-600 rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="/js/main.js"></script>
  <script>
    // live search (fallback if main.js missing)
    document.getElementById('search').addEventListener('input', function () {
      const term = this.value.toLowerCase();
      document.querySelectorAll('.attendee-row').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
      });
    });

    // socket auto-reload fallback
    if (typeof io === 'function') {
      const socket = io();
      socket.on('update-attendees', () => window.location.reload());
    }
  </script>
</body>
</html>